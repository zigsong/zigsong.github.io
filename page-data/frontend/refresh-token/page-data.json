{"componentChunkName":"component---src-templates-blog-post-js","path":"/frontend/refresh-token/","result":{"data":{"site":{"siteMetadata":{"title":"ziglog","author":"zigsong","lang":"en"}},"markdownRemark":{"id":"984971f9-fc94-5c6d-a3aa-8b40cc59abaa","excerpt":"SSR | refreshToken 기존 놀토 프로젝트에서의 로그인은, 로그인 요청을 보내면 서버에서 보내주는 accessToken을 localStorage에 저장하는 방식으로 이루어졌다. 에 accessToken이 있다면 userInfo…","html":"<p>SSR | refreshToken</p>\n<!-- more -->\n<p>기존 놀토 프로젝트에서의 로그인은, 로그인 요청을 보내면 서버에서 보내주는 accessToken을 localStorage에 저장하는 방식으로 이루어졌다. <code class=\"language-text\">localStorage</code>에 accessToken이 있다면 userInfo를 생성하여 현재 로그인 중인 유저의 정보를 만들어냈다.</p>\n<p>하지만 이 방식은 XSS 공격에 너무나 취약하다! 해커가 악성 스크립트를 삽입한다면 사용자의 토큰을 탈취하여 해당 사용자의 계정을 마음대로 이용할 수 있게 된다.</p>\n<p>이 문제를 해결하기 위해 등장한 방식 중 하나가 <strong>refreshToken</strong>이다. 사실 refreshToken은 <a href=\"https://zigsong.github.io/2021/09/18/wtc-week-32/#%ED%94%84%EB%A1%A0%ED%8A%B8%EC%97%90%EC%84%9C-%EC%95%88%EC%A0%84%ED%95%98%EA%B2%8C-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%B2%98%EB%A6%AC%ED%95%98%EA%B8%B0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">이전에도 잠깐 언급</a>하고 지나갔었는데, 이번 기회에 본격적으로 도입해보게 되었다.</p>\n<p>간단하게 정리하자면 아래와 같다.</p>\n<blockquote>\n<ul>\n<li>accessToken, refreshToken 모두 JWT를 사용한다.</li>\n<li>refreshToken은 클라이언트의 쿠키로 저장하며, 유효기간을 길게 설정한다.</li>\n<li>accessToken은 앱 내 변수로 관리한다.</li>\n<li>클라이언트에서 서버 데이터 요청 시 accessToken으로 인증된 사용자의 여부를 판단한다.</li>\n</ul>\n</blockquote>\n<p>팀원들과 논의하여 refreshToken을 세션(브라우저의 session storage가 아닌, 클라이언트-서버를 연결하는 세션)에 담는 방법과 쿠키에 담는 방법 두 가지를 생각해봤다. 결론적으로 선택한 것은 쿠키였지만, 그전에 세션에 담는 방법을 간단하게 살펴보고 넘어가자.</p>\n<hr>\n<h2 id=\"-세션에-refreshtoken-담기\" style=\"position:relative;\"><a href=\"#-%EC%84%B8%EC%85%98%EC%97%90-refreshtoken-%EB%8B%B4%EA%B8%B0\" aria-label=\" 세션에 refreshtoken 담기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🌐 세션에 refreshToken 담기</h2>\n<ol>\n<li>클라이언트가 백엔드 서버에 로그인을 요청한다.</li>\n<li>서버는 JSON 형태의 <code class=\"language-text\">accessToken</code>과 <code class=\"language-text\">refreshToken</code>을 반환한다.</li>\n<li>클라이언트는 <code class=\"language-text\">accessToken</code>을 앱 내 변수에 저장하고, 서버에 <code class=\"language-text\">accessToken</code>을 보내 <code class=\"language-text\">userInfo</code>를 응답 받는다.</li>\n<li><code class=\"language-text\">accessToken</code>, <code class=\"language-text\">refreshToken</code>, <code class=\"language-text\">userInfo</code>를 SSR 서버로 전달한다.</li>\n<li>SSR 서버는 <code class=\"language-text\">accessToken</code>, <code class=\"language-text\">refreshToken</code>, <code class=\"language-text\">userInfo</code>를 담은 세션을 생성한다. 이때 세션의 유효기간은 <code class=\"language-text\">refreshToken</code>의 유효기간과 같다.</li>\n<li>이렇게 생성한 세션ID를 nginx 웹서버로 전달한다.</li>\n<li>nginx 웹서버는 세션ID를 클라이언트의 쿠키로 전송한다.</li>\n</ol>\n<h3 id=\"-문제점\" style=\"position:relative;\"><a href=\"#-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\" 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>😈 문제점</h3>\n<p><strong>1) 쿠키에 담겨 있는 세션ID가 탈취당할 수 있다?</strong>\n쿠키에 세션ID를 저장하든, <code class=\"language-text\">refreshToken</code>을 곧바로 저장하든 XSS 공격은 막을 수 있겠지만 CSRF 공격에는 취약하다.\nCSRF 공격을 받았을 경우를 생각해 보자. 이때도 해커는 <code class=\"language-text\">refreshToken</code>으로 <code class=\"language-text\">accessToken</code>에 대한 재발급 요청만 가능할 뿐, 여전히 <code class=\"language-text\">accessToken</code>에 직접 접근할 수는 없다. 유저 정보를 이용하여 서버의 데이터를 가져오거나 변경하는 것은 <code class=\"language-text\">refreshToken</code>이 아닌 <code class=\"language-text\">accessToken</code>이 있어야 가능한 일이다. 즉, CSRF 공격을 통해 전달받은 결과로 서버의 데이터에 영향을 미치는 행동을 할 수는 없다. 해커가 <code class=\"language-text\">accessToken</code>을 재발급하는 요청을 강제로 실행시킨다한들 해당 <code class=\"language-text\">accessToken</code> 이용하여 어떤 동작을 수행할 수는 없는 것이다.</p>\n<p><strong>2) SSR 서버의 세션 부하가 너무 많이 발생한다!</strong>\n로그인 요청이 들어오는 모든 사용자마다 세션을 생성하여 관리해줘야 한다. 클라이언트의 렌더링에 직접 영향을 미치는 우리의 소중한 SSR 서버가 너무 많은 일을 맡는 것은 좋지 않아 보인다.</p>\n<hr>\n<h2 id=\"-쿠키에-refreshtoken-담기\" style=\"position:relative;\"><a href=\"#-%EC%BF%A0%ED%82%A4%EC%97%90-refreshtoken-%EB%8B%B4%EA%B8%B0\" aria-label=\" 쿠키에 refreshtoken 담기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🍪 쿠키에 refreshToken 담기</h2>\n<ol>\n<li>클라이언트가 백엔드 서버에 로그인을 요청한다.</li>\n<li>서버는 JSON 형태의 <code class=\"language-text\">accessToken</code>과 <code class=\"language-text\">refreshToken</code>을 반환한다.</li>\n<li>클라이언트는 <code class=\"language-text\">accessToken</code>을 앱 내 변수에 저장하고, 서버에 <code class=\"language-text\">accessToken</code>을 보내 <code class=\"language-text\">userInfo</code>를 응답 받는다.</li>\n<li>클라이언트는 SSR 서버에 (내부적으로) 로그인 요청을 보낸다. 이때 <code class=\"language-text\">refreshToken</code>을 요청 바디에 담아 보낸다.</li>\n<li><code class=\"language-text\">refreshToken</code>을 받은 SSR 서버는 응답으로 클라이언트의 쿠키에 <code class=\"language-text\">refreshToken</code>을 저장한다. 이때 쿠키의 유효기간은 <code class=\"language-text\">refreshToken</code>의 유효기간과 같다.</li>\n<li>클라이언트는 앱 내 변수로 <code class=\"language-text\">accessToken</code>을, 쿠키에 <code class=\"language-text\">refreshToken</code>을 갖게 되었다. 이제 클라이언트는 유저 정보가 필요한 요청에는 <code class=\"language-text\">accessToken</code>을 담아 전송한다.</li>\n<li>클라이언트에서 페이지 새로고침 발생 시 앱 내 변수인 <code class=\"language-text\">accessToken</code>은 지워진다. 이때 클라이언트는 쿠키에 보관하고 있는 <code class=\"language-text\">refreshToken</code>을 SSR 서버에 전송하고, SSR 서버는 클라이언트의 ip를 확인하여 백엔드 서버에 토큰 재발급 요청을 전송한다.</li>\n<li>토큰 재발급 요청에 대한 응답으로 SSR 서버는 새로운 <code class=\"language-text\">accessToken</code>과 <code class=\"language-text\">refreshToken</code>을 갖게 되었다.</li>\n<li>SSR 서버는 새로운 토큰을 이용해서 유저 정보를 prefetch하여 로그인된/로그아웃된 상태의 html을 클라이언트에 보내주고, (nginx 웹서버를 거친다.) script에 새로운 <code class=\"language-text\">accessToken</code>을 심어보낸다.</li>\n<li>(추가) 유저가 로그인되어 있는 상태에서 <code class=\"language-text\">accessToken</code>의 유효기간이 지난다면, 다시 서버로 토큰 재발급 요청을 보낸다.</li>\n</ol>\n<p>그림으로 살펴보자.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/269b0249d52edea303af9d29b3d5bdcb/a0730/01.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACEElEQVQ4y3WSy2/TQBDG/Vdz5Io4cEHqASHxOIKEVMEFCcRLFKkFQTnQIKBNk9hJmjjOw17b6/XOD3nXcQKCkVba2Z355pv5JkAEARCLt9ZXGYxDiGdQ5HRxTURtEF24g3sVRPxv4C62JlslPLt3wGzYdx/lUlFchlRhiO6PMKvUFZV0hVQau05gk7CMBhSblcNoIANbGwfw43uPW9evcfrpxPlZVrJIYTDV9EawTi0YBaUCU7K1h7dv8uXDO3e31hK4VirNMIx4/faI/uUQU+ZkyjBZWKJYmDZkMkuhNFdrGE9LxnGNquDRgzucHh+1gELQXOI4pnf2jSgMuTj/RRRF2O3A2hnlpbBMhf5EOB8Lw5lQakHNI/J52KD5lruBWguVZmceUfbE8G878WjG1YjZgHWi+CzPw1oWScUyg9lSiNeeHWmKTCYQz0lmObrebYN0pX3xoAMzBsYRxeiKtYLLK5gkbeBiAaMhZjQmWgiqELTxAC5f9tam2y+tEaXc/hVJCtSgM8gzpCrBGkpVURo4G1j605alx+wsYL/l3eSwRc7754cMzr7y8ukTjErdT21htoKs2M74b0DPVaTl7azR32g5fnEo0UVPfn58JabMBbEuv4XwOfzBRYKdgNtZeLfMNjy+e8DPzye8uX+DbD7eqb4X96+WO/S2pGeqC1FJLCbbSLmcixTKv/+H2Zbhb1W17ZV+xIudAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"01\" title=\"01\" src=\"/static/269b0249d52edea303af9d29b3d5bdcb/fcda8/01.png\" srcset=\"/static/269b0249d52edea303af9d29b3d5bdcb/12f09/01.png 148w,\n/static/269b0249d52edea303af9d29b3d5bdcb/e4a3f/01.png 295w,\n/static/269b0249d52edea303af9d29b3d5bdcb/fcda8/01.png 590w,\n/static/269b0249d52edea303af9d29b3d5bdcb/efc66/01.png 885w,\n/static/269b0249d52edea303af9d29b3d5bdcb/a0730/01.png 1131w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<blockquote>\n<p><strong>😮 왜 백엔드 서버에서 <code class=\"language-text\">refreshToken</code>을 직접 쿠키에 담지 않았나?</strong></p>\n</blockquote>\n<p>백엔드에서 쿠키를 설정하는 상황을 가정해보자.</p>\n<ol>\n<li>\n<p><code class=\"language-text\">SameSite</code> 속성값을 <code class=\"language-text\">Lax</code> 또는 <code class=\"language-text\">Strict</code>로 설정해주고, <code class=\"language-text\">Domain</code> 속성에는 SSR 서버의 도메인을 설정해 준다. 이렇게하면 refreshToken 요청은 SSR 서버만 사용할 수 있게 될 것이다. 문제는 개발 환경인데, 개발 중에는 localhost에서 SSR 서버를 돌리는 프론트엔드의 입장에서 쿠키의 동작을 확인하기가 어려워진다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">SameSite=None</code> 설정\n그렇다고 <code class=\"language-text\">SameSite</code> 속성값을 <code class=\"language-text\">None</code>으로 설정하면, 크로스 사이트 요청의 경우에도 항상 전송된다. 모든 서드파티 쿠키를 허용하는 것으로, 보안적으로 가장 취약하며 <code class=\"language-text\">Secure</code> 옵션을 반드시 함께 붙여줘야 한다. 보안 설정이 따로 필요하다.</p>\n</li>\n</ol>\n<p>즉 쿠키의 보안 옵션을 설정하는 과정에서의 번거로움(특히, 개발 단계에서 localhost를 사용하는 경우) 때문에 JSON으로 내려주게 되었다.</p>\n<p>페이지 리로드 시 <code class=\"language-text\">accessToken</code>은 만료되기 때문에 <code class=\"language-text\">refreshToken</code>과 <code class=\"language-text\">accessToken</code>을 재발급받아야 한다. 이때 SSR 서버를 거쳐 토큰 재발급을 요청하게 되는데, 요청을 보내는 클라이언트의 IP가 가장 처음 로그인 시 요청을 보냈던 클라이언트의 IP와 다르다면 백엔드 서버는 <code class=\"language-text\">401 Unauthorized</code> 에러를 반환한다.</p>\n<p>그렇게 해서 아래와 같은 코드가 탄생하게 되었다.</p>\n<hr>\n<h2 id=\"️-대망의-코드\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-%EB%8C%80%EB%A7%9D%EC%9D%98-%EC%BD%94%EB%93%9C\" aria-label=\"️ 대망의 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤸‍♀️ 대망의 코드</h2>\n<blockquote>\n<p><strong>📜 api 설명</strong></p>\n<ul>\n<li><code class=\"language-text\">/login/oauth/${type}/token?code=${code}</code>: 클라이언트에서 백엔드 서버로 보내는 로그인 요청. 응답으로 <code class=\"language-text\">refreshToken</code>과 <code class=\"language-text\">accessToken</code>을 받는다.</li>\n<li><code class=\"language-text\">/auth/login</code>: 클라이언트에서 SSR 서버로 보내는 로그인 요청. SSR 서버는 refreshToken을 쿠키에 담아 응답을 전송한다.</li>\n<li><code class=\"language-text\">/auth/logout</code>: 클라이언트에서 SSR 서버로 보내는 로그아웃 요청. SSR 서버는 쿠키에서 refreshToken을 삭제한다.</li>\n<li><code class=\"language-text\">/login/oauth/refreshToken</code>: SSR 서버에서 백엔드 서버로 보내는 토큰 재발급 요청. 클라이언트에서 페이지 리로드 시 accessToken이 사라지므로 매번 재발급을 해준다. 요청이 유효하다면 새로운 refreshToken과 accessToken을 응답으로 보내준다.</li>\n</ul>\n</blockquote>\n<p>클라이언트 측 코드부터 살펴보자. 클라이언트에서 백엔드 서버에 로그인을 보내는 요청 코드는 다음과 같다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// src/hooks/useOAuthLogin.ts</span>\n<span class=\"token keyword\">const</span> useOAuthLogin <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>type<span class=\"token operator\">:</span> <span class=\"token string\">\"google\"</span> <span class=\"token operator\">|</span> <span class=\"token string\">\"github\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> history <span class=\"token operator\">=</span> <span class=\"token function\">useHistory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> login <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 백엔드 서버로 OAuth 로그인 요청을 보낸다.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getAccessToken</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>code<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> api<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">get</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>AuthData<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n      <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/login/oauth/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">type</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/token?code=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">login</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ROUTE</span><span class=\"token punctuation\">.</span><span class=\"token constant\">HOME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위에서 사용하는 <code class=\"language-text\">useMember</code> hook의 <code class=\"language-text\">login</code> 함수는 아래 Context Provider 코드에서 확인할 수 있다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// src/contexts/member/MemberProvider.tsx</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">MemberProvider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> children <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> Props<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token function\">useQueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> modal <span class=\"token operator\">=</span> <span class=\"token function\">useModal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> dialog <span class=\"token operator\">=</span> <span class=\"token function\">useDialog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>accessToken<span class=\"token punctuation\">,</span> setAccessToken<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// userInfo를 가져오는 요청을 보낸다.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> userInfo<span class=\"token punctuation\">,</span> refetch<span class=\"token operator\">:</span> refetchMember <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMyInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    accessToken<span class=\"token punctuation\">,</span>\n    errorHandler<span class=\"token operator\">:</span> <span class=\"token comment\">// ...,</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">login</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>authData<span class=\"token operator\">:</span> AuthData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setAccessToken</span><span class=\"token punctuation\">(</span>authData<span class=\"token punctuation\">.</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 로그인 응답으로 받은 data를 SSR 서버에 전송한다.</span>\n    frontendApi<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/auth/login'</span><span class=\"token punctuation\">,</span> authData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logout</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// member query에 캐시되어있는 값을 제거해준다.</span>\n    queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">removeQueries</span><span class=\"token punctuation\">(</span><span class=\"token constant\">QUERY_KEYS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MEMBER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    backendApi<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">[</span><span class=\"token string\">'Authorization'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n    frontendApi<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/auth/logout'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> contextValue<span class=\"token operator\">:</span> ContextValue <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Context.Provider</span></span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>contextValue<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Context.Provider</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">accessToken</code>을 전반적으로 관리하는 hook인 <code class=\"language-text\">useAccessToken</code>을 작성했다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">EXPIRED_IN</span> <span class=\"token operator\">=</span> <span class=\"token number\">71400000</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useAccessToken</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 서버에서 script 태그로 받은 accessToken을 앱 내 변수로 담는다.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>accessToken<span class=\"token punctuation\">,</span> setAccessToken<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>\n    hasWindow <span class=\"token operator\">?</span> window<span class=\"token punctuation\">.</span>__accessToken__ <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 사용자가 로그인된 상태에서 accessToken이 만료된다면, 서버에 다시 토큰 재발급 요청을 보낸다.</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> timerId <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n        data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> accessToken <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> frontendApi<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">post</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">{</span> accessToken<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth/renewToken\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token function\">setAccessToken</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      backendApi<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"Authorization\"</span>\n      <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>accessToken<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">EXPIRED_IN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timerId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>accessToken<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>accessToken<span class=\"token punctuation\">,</span> setAccessToken<span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>SSR 서버의 코드는 다음과 같다. <code class=\"language-text\">/auth</code>로 시작하는 요청에 대한 엔드포인트는 모두 한 곳에서 처리해주도록 express router를 사용했다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// server/index.tsx</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth\"</span><span class=\"token punctuation\">,</span> authRoute<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>auth와 관련된 요청들을 살펴보자.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// server/auth.ts</span>\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> express<span class=\"token punctuation\">.</span><span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> body <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isAuthRequest <span class=\"token operator\">=</span>\n    body<span class=\"token operator\">?.</span>accessToken <span class=\"token operator\">&amp;&amp;</span> body<span class=\"token operator\">?.</span>refreshToken <span class=\"token operator\">&amp;&amp;</span> body<span class=\"token operator\">?.</span>expiredIn<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isAuthRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"올바른 요청 양식이 아닙니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  res\n    <span class=\"token punctuation\">.</span><span class=\"token function\">cookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">.</span>refreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      httpOnly<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      maxAge<span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>expiredIn<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 로그아웃 요청 시 쿠키의 refreshToken을 제거해준다.</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/logout\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">clearCookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/renewToken\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> accessToken<span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> expiredIn <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getNewAuthToken</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  res\n    <span class=\"token punctuation\">.</span><span class=\"token function\">cookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      httpOnly<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      maxAge<span class=\"token operator\">:</span> expiredIn<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> accessToken <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> router<span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>일반적으로 <code class=\"language-text\">axios</code> 등의 메서드를 이용하여 서로 다른 도메인 간에 쿠키를 주고받을 때는 CORS 문제에 걸려 쿠키를 정상적으로 받을 수 없다. 이를 해결하기 위해 클라이언트에서 요청을 보낼 때 <code class=\"language-text\">{ withCredentials: true }</code> 옵션을 설정하고, 서버에서는 응답 시 <code class=\"language-text\">{ credentials: true }</code> 옵션을 설정해줘야 한다. 하지만 현재 앱 구조 상 SSR 서버에서 클라이언트 페이지까지 띄우고 있는 구조(isomorphic, 즉 서버와 클라이언트가 같은 도메인을 사용)이므로 해당 설정을 해줄 필요가 없다.</p>\n</blockquote>\n<p>클라이언트에서 토큰을 재발급 받는 요청에는 아래 함수가 호출된다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// server/utils.ts</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PUBLIC_IP_API</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://api.ipify.org/?format=text\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> getNewAuthToken <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> express<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>AuthData<span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 클라이언트에 refreshToken이 없다면 로그아웃 상태로, 토큰 재발급 요청을 하지 않는다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>req<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>refreshToken<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> refreshToken <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// nginx proxy 환경에서 client IP를 가져오는 방법</span>\n  <span class=\"token keyword\">let</span> clientIP <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"x-forwarded-for\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 처음 로그인 요청을 보낸 클라이언트의 ip와 토큰 재발급 요청을 보낸 클라이언트의 ip가 다르다면 백엔드 서버에서 401 에러를 리턴한다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">!==</span> <span class=\"token string\">\"production\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> publicIP <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PUBLIC_IP_API</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    clientIP <span class=\"token operator\">=</span> publicIP<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 클라이언트가 전송한 stale한 refreshToken으로 새 refreshToken을 발급받는다.</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> authData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> api<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">post</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>AuthData<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">\"/login/oauth/refreshToken\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        refreshToken<span class=\"token punctuation\">,</span>\n        clientIP<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> authData<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>리버스 프록시 역할을 하는 nginx를 거쳐 client IP를 얻기 위해서는 request header의 <code class=\"language-text\">x-forwarded-for</code>를 이용할 수 있다. <code class=\"language-text\">XFF</code>(<code class=\"language-text\">x-forwarded-for</code>)는 표준 헤더는 아니지만, HTTP 프록시나 로드 밸런서를 통해 웹 서버에 접속하는 클라이언트의 원 IP 주소를 식별하는 사실상의 표준 헤더라고 할 수 있다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">let</span> clientIP <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"x-forwarded-for\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>nginx 설정은 아래와 같이 작성해준다. <a href=\"https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">공식 문서</a>를 참고했으며, <code class=\"language-text\">$proxy_add_x_forwarded_for</code> 변수는 요청으로 들어오는 <code class=\"language-text\">x-forwarded-for</code> 헤더들에 자동으로 <code class=\"language-text\">$remote_addr</code>를 붙여준다고 한다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// etc/nginx/sites-available/default\nserver {\n  location / {\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $http_host;\n    proxy_pass http://localhost:9000/;\n  }\n  // ...\n}</code></pre></div>\n<p>또 development 모드에서는 클라이언트의 request ip가 127.0.0.1(localhost)로 되어 있기 때문에, public ip를 받아올 수 있는 API(<code class=\"language-text\">PUBLIC_IP_API</code>)를 사용했다.</p>\n<p>이후 클라이언트에서 페이지 요청이 들어올 때마다 SSR 서버는 새로운 토큰을 발급받는 <code class=\"language-text\">getNewAuthToken</code>을 호출하여 분주하게 움직인다. 토큰 재발급이 완료되면 1. 새로운 <code class=\"language-text\">refreshToken</code>과 2. <code class=\"language-text\">accessToken</code>을 클라이언트에 전송하며, 3. 유저 정보도 미리 prefetch하여 html을 적절하게 구성한다.</p>\n\n          <div class=\"gatsby-remark-prismjs-copy-button-container\">\n            <div class=\"gatsby-remark-prismjs-copy-button\" tabindex=\"0\" role=\"button\" aria-pressed=\"false\" onclick=\"gatsbyRemarkCopyToClipboard(this, this.parentNode.nextElementSibling)\">\n              Copy\n            </div>\n          </div>\n          \n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> newAuthData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getNewAuthToken</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 1. 재발급받은 토큰이 있다면 cookie에 refreshToken을 담아주고,</span>\n  <span class=\"token comment\">// 3. 유저 정보를 새로 prefetch하여 로그인된 상태의 html을 구성한다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newAuthData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">cookie</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span> newAuthData<span class=\"token punctuation\">.</span>refreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      httpOnly<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      maxAge<span class=\"token operator\">:</span> newAuthData<span class=\"token punctuation\">.</span>expiredIn<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">await</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">prefetchQuery</span><span class=\"token punctuation\">(</span><span class=\"token constant\">QUERY_KEYS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MEMBER</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n      <span class=\"token function\">getMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> accessToken<span class=\"token operator\">:</span> newAuthData<span class=\"token punctuation\">.</span>accessToken <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 2. 재발급받은 accessToken을 클라이언트에 script로 전송한다.</span>\n  <span class=\"token keyword\">const</span> accessTokenScript <span class=\"token operator\">=</span> newAuthData\n    <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;script>window.__accessToken__ = \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>newAuthData<span class=\"token punctuation\">.</span>accessToken<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"&lt;/script></span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>indexFile<span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf8\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> data\n      <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;div id=\"root\">&lt;/div>'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;div id=\"root\"></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>reactApp<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/div></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n        <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">&lt;head>(.+)&lt;\\/head></span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">s</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;head>$1\n          </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>styleTags<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>scriptTags<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>reactQueryState<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>accessTokenScript<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n         &lt;/head></span><span class=\"token template-punctuation string\">`</span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><del>아직도 끝나지 않은 SSR의 여정! 다음주에 계속됩니다…</del>\n드디어 끝났당! 후련하다 🤩 많이 삽질하고 많이 배울 수 있었다. 페어 미키가 함께 해준 덕에 가능했다. 리팩토링은 더 해야 하겠지만 큰일 없이 돌아가기를 바란다.</p>\n<hr>\n<p><strong>Ref</strong>\n<a href=\"https://pomo0703.tistory.com/208\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://pomo0703.tistory.com/208</a>\n<a href=\"https://velog.io/@0307kwon/CSR-%EC%95%B1%EC%97%90%EC%84%9C-SSR-CSR-%ED%99%98%EA%B2%BD%EC%9C%BC%EB%A1%9C-%EC%9D%B4%EC%A3%BC%ED%95%98%EA%B8%B0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://velog.io/@0307kwon/CSR-앱에서-SSR-CSR-환경으로-이주하기</a>\n<a href=\"https://velog.io/@yaytomato/%ED%94%84%EB%A1%A0%ED%8A%B8%EC%97%90%EC%84%9C-%EC%95%88%EC%A0%84%ED%95%98%EA%B2%8C-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%B2%98%EB%A6%AC%ED%95%98%EA%B8%B0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://velog.io/@yaytomato/프론트에서-안전하게-로그인-처리하기</a>\n<a href=\"https://seob.dev/posts/%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%BF%A0%ED%82%A4%EC%99%80-SameSite-%EC%86%8D%EC%84%B1/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://seob.dev/posts/브라우저-쿠키와-SameSite-속성/</a>\n<a href=\"https://web.dev/samesite-cookie-recipes/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://web.dev/samesite-cookie-recipes/</a></p>","timeToRead":10,"frontmatter":{"title":"로그인에 refreshToken 적용하기","date":"October 16, 2021","description":null,"tags":["frontend"],"disqus":null},"fields":{"langKey":"en"}}},"pageContext":{"slug":"/frontend/refresh-token/","previous":{"fields":{"slug":"/wtc/wtc-week-35/","langKey":"en","directoryName":"wtc"},"frontmatter":{"date":"October 16, 2021","description":null,"title":"우테코 35주차 기록","tags":["woowacourse"]}},"next":{"fields":{"slug":"/react/await-setstate/","langKey":"en","directoryName":"react"},"frontmatter":{"date":"October 16, 2021","description":null,"title":"React의 setState에 await을 붙이면?","tags":["react"]}},"previousInSameTag":{"fields":{"slug":"/frontend/lottie/","langKey":"en","directoryName":"frontend"},"frontmatter":{"date":"December 08, 2022","description":null,"title":"로티로 애니메이션 만들기","tags":["frontend"]}},"nextInSameTag":{"fields":{"slug":"/frontend/apple-clone/","langKey":"en","directoryName":"frontend"},"frontmatter":{"date":"September 18, 2021","description":null,"title":"애플 클론코딩(을 빙자한 복제)","tags":["frontend"]}},"translationsLink":[]}},"staticQueryHashes":["1522010811","2466007692","2894998521","3765107650","683610688"]}